import os
import gspread
from datetime import datetime
from oauth2client.service_account import ServiceAccountCredentials
from dotenv import load_dotenv

load_dotenv()

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
SHEET_ID = os.getenv("GOOGLE_SHEET_ID")
CREDS_PATH = "credentials/google/ibilshbot-7c4d1bbce9ea.json"


# === –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç ===
scope = [
    "https://spreadsheets.google.com/feeds",
    "https://www.googleapis.com/auth/drive"
]
creds = ServiceAccountCredentials.from_json_keyfile_name(CREDS_PATH, scope)
client = gspread.authorize(creds)
sheet = client.open_by_key(SHEET_ID).sheet1  # –ø–µ—Ä–≤–∞—è –≤–∫–ª–∞–¥–∫–∞


def append_payment_row(tg_id: int, username: str, dates: list, weeks_count: int, photo_file_id: str):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ Google –¢–∞–±–ª–∏—Ü—É.
    :param tg_id: Telegram ID –∫–ª–∏–µ–Ω—Ç–∞
    :param username: username –∫–ª–∏–µ–Ω—Ç–∞ (—Å @ –∏–ª–∏ '–Ω–µ —É–∫–∞–∑–∞–Ω')
    :param dates: —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ –¥–∞—Ç –≤–∏–¥–∞ 14.06.2025
    :param weeks_count: –∫–æ–ª-–≤–æ –Ω–µ–¥–µ–ª—å –æ–ø–ª–∞—Ç—ã
    :param photo_file_id: file_id Telegram-—Å–Ω–∏–º–∫–∞
    """
    print("üì§ –ó–∞–ø–∏—Å—ã–≤–∞—é –≤ Google –¢–∞–±–ª–∏—Ü—É...")
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    sheet.append_row([
        str(tg_id),
        username,
        now,
        ", ".join(dates),
        str(weeks_count),
        photo_file_id
    ])